/*!
 * slimtable ( https://slimtable.mcfish.org/ )
 *
 * Licensed under MIT license.
 *
 * @version 2.0.0
 * @author Pekka Harjamäki
 */
!function(o){var s={init:function(t,s){t.data("slimTableObj",this),this.settings=o.extend({tableData:null,dataUrl:null,itemsPerPage:10,ippList:[5,10,20],pagingStart:0,keepAttrs:[],sortList:[],colSettings:[],text1:"items/page",text2:"Loading...",sortStartCB:null,sortEndCB:null},s),this.state={showLoader:!1,cleanerDiv:o("<div></div>"),colSettings:[],tblData:[],sortList:0<this.settings.sortList.length?this.settings.sortList:[],pagingStart:parseInt(this.settings.pagingStart),itemsPerPage:parseInt(this.settings.itemsPerPage),tableHeads:t.find("thead tr th"),tableBody:t.find("tbody")},0===this.state.tableHeads.length||0===this.state.tableBody.length?this.showError("thead/tbody missing from table!"):(this.parseColSettings(),this.readTable(),!1!==this.state.showLoader||this.sanityCheck()?(t.addClass("slimtable"),this.addSortIcons(),this.addPaging(t),this.doSorting()):this.showError("Different number of columns in header and data!"))},parseColSettings:function(){for(let t=0;t<this.state.tableHeads.length;t++){this.state.colSettings[t]={enableSort:!0,classes:[],stripHtml:!1,sortDir:"asc",rowType:-1,colNumber:t};for(var s of this.settings.colSettings)if(s.colNumber===t){!1===s.enableSort&&(this.state.colSettings[t].enableSort=!1),!0===s.stripHtml&&(this.state.colSettings[t].stripHtml=!0),"asc"!==s.sortDir&&"desc"!==s.sortDir||(this.state.colSettings[t].sortDir=s.sortDir),0<=s.rowType&&(this.state.colSettings[t].rowType=s.rowType),s.addClasses&&0<s.addClasses.length&&(this.state.colSettings[t].classes=s.addClasses);break}}},returnRowType:function(t){return 0===t.length?-1:/[^0-9]/g.test(t)?/^[0-9]+([.,][0-9]+)?$/.test(t)?2:/^([0-9]+([.,][0-9]+)?)\s*[%$€£e]?$/.test(t)?3:/^[0-9]{1,2}[.-/][0-9]{1,2}[.-/][0-9]{4}$/.test(t)?4:0:1},readTable:function(){var t,s,a,e,i,l;if(this.settings.dataUrl&&2<this.settings.dataUrl.length)this.showLoader=!0,o.ajax({url:this.settings.dataUrl,dataType:"json"}).done(function(t){this.processData(t),this.showLoader=!1,this.createTableBody()}).fail(function(t,s){this.showError("Ajax error: "+s)});else if(this.settings.tableData&&0<=this.settings.tableData.length)this.processData(this.settings.tableData);else{let s=this;this.state.tableBody.find("tr").each(function(){i={data:[],attrs:[]};for(var t of s.settings.keepAttrs)void 0!==(l=o(this).attr(t))&&i.attrs.push({attr:t,value:l});o(this).find("td").each(function(){e={orig:o(this).html(),attrs:[],clean:null},null!=(l=o(this).attr("sort-data"))&&(e.clean=l);for(var t of s.settings.keepAttrs)void 0!==(l=o(this).attr(t))&&e.attrs.push({attr:t,value:l});i.data.push(e)}),s.state.tblData.push(i)})}if(this.sanityCheck())for(t=0;t<this.state.tableHeads.length;t++){if(a=[0,0,0,0,0],-1===this.state.colSettings[t].rowType){for(s=0;s<this.state.tblData.length;s++)null===(e=this.state.tblData[s].data[t]).clean?(e=this.state.colSettings[t].stripHtml?this.state.cleanerDiv.html(e.orig).text():e.orig,e=o.trim(e).toLowerCase(),this.state.tblData[s].data[t].clean=e):e=e.clean,0<(l=this.returnRowType(e))&&a[l]++;this.state.colSettings[t].rowType=o.inArray(Math.max.apply(this,a),a)}for(s=0;s<this.state.tblData.length;s++)l=this.state.colSettings[t].rowType,e=this.state.tblData[s].data[t].clean,0===l&&(this.state.tblData[s].data[t].clean=String(e)),2!==l&&3!==l||(this.state.tblData[s].data[t].clean=parseFloat(e.replace(",","."))),4===l&&(e=e.split(/[./-]/),this.state.tblData[s].data[t].clean=new Date(e[2],e[1],e[0]))}},processData:function(t){var s,a,e;for(this.state.tblData=[],s=0;s<t.length;s++){for(e={data:[],attrs:[]},a=0;a<t[s].length;a++)e.data.push({orig:t[s][a],attrs:[],clean:null});this.state.tblData.push(e)}},createTableHead:function(){for(var t,s,a=0;a<this.state.tableHeads.length;a++)this.state.colSettings[a]&&this.state.colSettings[a].enableSort&&(s=(t=o(this.state.tableHeads[a])).find("span"),o.inArray(a,this.state.sortList)<0?(t.removeClass("slimtable-activeth"),s.removeClass("slimtable-sortasc").removeClass("slimtable-sortdesc").addClass("slimtable-sortboth")):(t.addClass("slimtable-activeth"),s.removeClass("slimtable-sortboth").removeClass("slimtable-sort"+("asc"===this.state.colSettings[a].sortDir?"desc":"asc")).addClass("slimtable-sort"+this.state.colSettings[a].sortDir)))},createTableBody:function(){var t,s,a,e,i,l,r=this.state.pagingStart+this.state.itemsPerPage,n=Math.ceil(this.state.tblData.length/this.state.itemsPerPage);for(this.state.tableBody.empty(),r=r>this.state.tblData.length?this.state.tblData.length:r,e=this.state.pagingStart;e<r;e++){for(s=o("<tr></tr>"),l=0;l<this.state.tblData[e].attrs.length;l++)o(s).attr(this.state.tblData[e].attrs[l].attr,this.state.tblData[e].attrs[l].value);for(i=0;i<this.state.tblData[e].data.length;i++){for(t=this.state.tblData[e].data[i],a=o("<td></td>").html(t.orig),l=0;l<t.attrs.length;l++)o(a).attr(t.attrs[l].attr,t.attrs[l].value);for(l=0;l<this.state.colSettings[i].classes.length;l++)o(a).addClass(this.state.colSettings[i].classes[l]);o(s).append(a)}this.state.tableBody.append(s)}for(o(this.state.btnContainer).empty(),e=0;e<n;e++)s=document.createElement("div"),o(s).addClass("slimtable-page-btn").on("click",{self:this},this.handlePageChange).text(e+1),e*this.state.itemsPerPage===this.state.pagingStart&&o(s).addClass("active"),o(this.state.btnContainer).append(s)},addSortIcons:function(){let a=this;this.state.tableHeads.each(function(t){o(this).attr("unselectable","on");var s,t=a.state.colSettings[t];t&&t.enableSort?(s=o("<span></span>").attr("unselectable","on").addClass("slimtable-sprites"),"asc"===t.sortDir?s.addClass("slimtable-sortasc"):"desc"===t.sortDir?s.addClass("slimtable-sortdesc"):s.addClass("slimtable-sortboth"),o(this).prepend(s).css({cursor:"pointer"}).on("click",{self:a},a.handleHeaderClick)):o(this).addClass("slimtable-unsortable")})},addPaging:function(t){let s,a,e;e=o("<select></select>").addClass("slimtable-paging-select").on("change",{self:this},this.handleIppChange);for(let t of this.settings.ippList)a=o("<option></option>").val(t).text(t),t===this.settings.itemsPerPage&&a.attr("selected","selected"),o(e).append(a);a=o("<div></div>").addClass("slimtable-paging-btnsdiv"),this.state.btnContainer=a,s=o("<div></div>").addClass("slimtable-paging-div").append(a),a=o("<div></div>").addClass("slimtable-paging-seldiv").append(e).append(this.settings.text1),o(s).append(a),a=o("<div></div>").addClass("slimtable-container-div").append(s),t.before(a),t.insertBefore(s)},doSorting:function(){let o=this;0<this.state.sortList.length&&this.state.tblData.sort(function(t,s){for(var a,e,i,l,r=o.state.sortList.length,n=0;n<r;n++)if(a=o.state.sortList[n],i=("desc"===o.state.colSettings[a].sortDir?(e=s.data[a].clean,t):(e=t.data[a].clean,s)).data[a].clean,l=!1,0===o.state.colSettings[a].rowType?0===e.localeCompare(i)&&(l=!0):4===o.state.colSettings[a].rowType?e-i==0&&(l=!0):e===i&&(l=!0),!(l&&n<r-1))return 0===o.state.colSettings[a].rowType?e.localeCompare(i):e-i}),this.createTableHead(),this.createTableBody()},handleHeaderClick:function(t){var s=t.data.self,a=o(this).index(),e=o.inArray(a,s.state.sortList);t.preventDefault(),s.settings.sortStartCB&&"function"==typeof s.settings.sortStartCB&&s.settings.sortStartCB.call(s),t.shiftKey?e<0?(s.state.sortList.push(a),s.state.colSettings[a].sortDir="asc"):"asc"===s.state.colSettings[a].sortDir?s.state.colSettings[a].sortDir="desc":s.state.colSettings[a].sortDir="asc":(s.state.sortList=[a],!(e<0)&&"asc"===s.state.colSettings[a].sortDir?s.state.colSettings[a].sortDir="desc":s.state.colSettings[a].sortDir="asc"),s.doSorting(),s.settings.sortEndCB&&"function"==typeof s.settings.sortEndCB&&s.settings.sortEndCB.call(s)},handleIppChange:function(t){t=t.data.self;t.state.itemsPerPage=parseInt(this.value),t.state.pagingStart=0,t.createTableBody()},handlePageChange:function(t){var s=parseInt(o(this).text())-1,t=t.data.self,a=Math.ceil(t.state.tblData.length/t.state.itemsPerPage);s<0||a<=s||(t.state.pagingStart=s*t.state.itemsPerPage,t.createTableBody())},sanityCheck:function(){return!(0<this.state.tblData.length&&this.state.colSettings.length!==this.state.tblData[0].data.length)},showError:function(t){console.log("Slimtable: "+t)},getState:function(t){var t=t.data("slimTableObj");return t&&t.state?{colNumber:(t=t.state).colNumber,itemsPerPage:t.itemsPerPage,pagingStart:t.pagingStart,colSettings:t.colSettings,sortList:t.sortList}:{}}};o.fn.slimtable=function(t){return void 0!==t&&"getState"===t?s.getState(o(this[0])):this.each(function(){Object.create(s).init(o(this),t)})}}(jQuery);