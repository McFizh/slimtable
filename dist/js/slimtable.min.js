/*!
 * slimtable ( http://slimtable.mcfish.org/ )
 *
 * Licensed under MIT license.
 *
 * @version 1.3.1
 * @author Pekka Harjamäki
 */!function(a){"use strict";var b={init:function(b,c){return b.data("slimTableObj",this),this.settings=a.extend({tableData:null,dataUrl:null,itemsPerPage:10,ippList:[5,10,20],pagingStart:0,keepAttrs:[],sortList:[],colSettings:[],text1:"items/page",text2:"Loading...",sortStartCB:null,sortEndCB:null},c),this.state={showLoader:!1,cleanerDiv:a("<div></div>"),colSettings:[],tblData:[],sortList:this.settings.sortList.length>0?this.settings.sortList:[],pagingStart:parseInt(this.settings.pagingStart),itemsPerPage:parseInt(this.settings.itemsPerPage),tableHeads:b.find("thead tr th"),tableBody:b.find("tbody")},0===this.state.tableHeads.length||0===this.state.tableBody.length?void this.showError("thead/tbody missing from table!"):(this.parseColSettings(),this.readTable(),this.state.showLoader!==!1||this.sanityCheck()?(b.addClass("slimtable"),this.addSortIcons(),this.addPaging(b),void this.doSorting()):void this.showError("Different number of columns in header and data!"))},parseColSettings:function(){var a,b,c;for(a=0;a<this.state.tableHeads.length;a++)for(this.state.colSettings[a]={enableSort:!0,classes:[],stripHtml:!1,sortDir:"asc",rowType:-1,colNumber:a},b=0;b<this.settings.colSettings.length;b++)if(c=this.settings.colSettings[b],c.colNumber==a){c.enableSort===!1&&(this.state.colSettings[a].enableSort=!1),c.stripHtml===!0&&(this.state.colSettings[a].stripHtml=!0),"asc"!=c.sortDir&&"desc"!=c.sortDir||(this.state.colSettings[a].sortDir=c.sortDir),c.rowType>=0&&(this.state.colSettings[a].rowType=c.rowType),c.addClasses&&c.addClasses.length>0&&(this.state.colSettings[a].classes=c.addClasses);break}},returnRowType:function(a){var b=/[^0-9]/g,c=/^[0-9]+([\.,][0-9]+)?$/,d=/^([0-9]+([\.,][0-9]+)?)\s*[%$€£e]?$/,e=/^[0-9]{1,2}[.-\/][0-9]{1,2}[.-\/][0-9]{4}$/;return 0===a.length?-1:b.test(a)?c.test(a)?2:d.test(a)?3:e.test(a)?4:0:1},readTable:function(){var b,c,d,e,f,g,h;if(this.settings.dataUrl&&this.settings.dataUrl.length>2)this.showLoader=!0,a.ajax({url:this.settings.dataUrl,dataType:"json"}).done(function(a){this.processData(a),this.showLoader=!1,this.createTableBody()}).fail(function(a,b){this.showError("Ajax error: "+b)});else if(this.settings.tableData&&this.settings.tableData.length>=0)this.processData(this.settings.tableData);else{var i=this;this.state.tableBody.find("tr").each(function(){for(f={data:[],attrs:[]},b=0;b<i.settings.keepAttrs.length;b++)g=i.settings.keepAttrs[b],h=a(this).attr(g),"undefined"!=typeof h&&f.attrs.push({attr:g,value:h});a(this).find("td").each(function(){for(e={orig:a(this).html(),attrs:[],clean:null},h=a(this).attr("sort-data"),"undefined"!=typeof h&&null!==h&&(e.clean=h),b=0;b<i.settings.keepAttrs.length;b++)g=i.settings.keepAttrs[b],h=a(this).attr(g),"undefined"!=typeof h&&e.attrs.push({attr:g,value:h});f.data.push(e)}),i.state.tblData.push(f)})}if(this.sanityCheck())for(b=0;b<this.state.tableHeads.length;b++){if(d=[0,0,0,0,0],-1==this.state.colSettings[b].rowType){for(c=0;c<this.state.tblData.length;c++)e=this.state.tblData[c].data[b],null===e.clean?(e=this.state.colSettings[b].stripHtml?this.state.cleanerDiv.html(e.orig).text():e.orig,e=a.trim(e).toLowerCase(),this.state.tblData[c].data[b].clean=e):e=e.clean,h=this.returnRowType(e),h>0&&d[h]++;this.state.colSettings[b].rowType=a.inArray(Math.max.apply(this,d),d)}for(c=0;c<this.state.tblData.length;c++)h=this.state.colSettings[b].rowType,e=this.state.tblData[c].data[b].clean,0===h&&(this.state.tblData[c].data[b].clean=String(e)),2!=h&&3!=h||(this.state.tblData[c].data[b].clean=parseFloat(e.replace(",","."))),4==h&&(e=e.split(/[.\/-]/),this.state.tblData[c].data[b].clean=new Date(e[2],e[1],e[0]))}},processData:function(a){var b,c,d;for(this.state.tblData=[],b=0;b<a.length;b++){for(d={data:[],attrs:[]},c=0;c<a[b].length;c++)d.data.push({orig:a[b][c],attrs:[],clean:null});this.state.tblData.push(d)}},createTableHead:function(){var b,c,d;for(b=0;b<this.state.tableHeads.length;b++)this.state.colSettings[b]&&this.state.colSettings[b].enableSort&&(c=a(this.state.tableHeads[b]),d=c.find("span"),a.inArray(b,this.state.sortList)<0?(c.removeClass("slimtable-activeth"),d.removeClass("slimtable-sortasc").removeClass("slimtable-sortdesc").addClass("slimtable-sortboth")):(c.addClass("slimtable-activeth"),d.removeClass("slimtable-sortboth").removeClass("slimtable-sort"+("asc"==this.state.colSettings[b].sortDir?"desc":"asc")).addClass("slimtable-sort"+this.state.colSettings[b].sortDir)))},createTableBody:function(){var b,c,d,e,f,g,h=this.state.pagingStart+this.state.itemsPerPage,i=Math.ceil(this.state.tblData.length/this.state.itemsPerPage);for(this.state.tableBody.empty(),h=h>this.state.tblData.length?this.state.tblData.length:h,e=this.state.pagingStart;h>e;e++){for(c=a("<tr></tr>"),g=0;g<this.state.tblData[e].attrs.length;g++)a(c).attr(this.state.tblData[e].attrs[g].attr,this.state.tblData[e].attrs[g].value);for(f=0;f<this.state.tblData[e].data.length;f++){for(b=this.state.tblData[e].data[f],d=a("<td></td>").html(b.orig),g=0;g<b.attrs.length;g++)a(d).attr(b.attrs[g].attr,b.attrs[g].value);for(g=0;g<this.state.colSettings[f].classes.length;g++)a(d).addClass(this.state.colSettings[f].classes[g]);a(c).append(d)}this.state.tableBody.append(c)}for(a(this.state.btnContainer).empty(),e=0;i>e;e++)c=document.createElement("div"),a(c).addClass("slimtable-page-btn").on("click",{self:this},this.handlePageChange).text(e+1),e*this.state.itemsPerPage==this.state.pagingStart&&a(c).addClass("active"),a(this.state.btnContainer).append(c)},addSortIcons:function(){var b,c=this;this.state.tableHeads.each(function(d){if(a(this).attr("unselectable","on"),b=c.state.colSettings[d],b&&b.enableSort){var e=a("<span></span>").attr("unselectable","on").addClass("slimtable-sprites");"asc"==b.sortDir?e.addClass("slimtable-sortasc"):"desc"==b.sortDir?e.addClass("slimtable-sortdesc"):e.addClass("slimtable-sortboth"),a(this).prepend(e).css({cursor:"pointer"}).on("click",{self:c},c.handleHeaderClick)}else a(this).addClass("slimtable-unsortable")})},addPaging:function(b){var c,d,e,f;for(f=a("<select></select>").addClass("slimtable-paging-select").on("change",{self:this},this.handleIppChange),e=0;e<this.settings.ippList.length;e++)c=this.settings.ippList[e],d=a("<option></option>").val(c).text(c),c==this.settings.itemsPerPage&&d.attr("selected","selected"),a(f).append(d);d=a("<div></div>").addClass("slimtable-paging-btnsdiv"),this.state.btnContainer=d,c=a("<div></div>").addClass("slimtable-paging-div").append(d),d=a("<div></div>").addClass("slimtable-paging-seldiv").append(f).append(this.settings.text1),a(c).append(d),d=a("<div></div>").addClass("slimtable-container-div").append(c),b.before(d),b.insertBefore(c)},doSorting:function(){var a=this;this.state.sortList.length>0&&this.state.tblData.sort(function(b,c){var d,e,f,g,h,i=a.state.sortList.length;for(g=0;i>g;g++)if(d=a.state.sortList[g],"desc"==a.state.colSettings[d].sortDir?(e=c.data[d].clean,f=b.data[d].clean):(e=b.data[d].clean,f=c.data[d].clean),h=!1,0===a.state.colSettings[d].rowType?0===e.localeCompare(f)&&(h=!0):4==a.state.colSettings[d].rowType?e-f===0&&(h=!0):e==f&&(h=!0),!(h&&i-1>g))return 0===a.state.colSettings[d].rowType?e.localeCompare(f):e-f}),this.createTableHead(),this.createTableBody()},handleHeaderClick:function(b){var c=a(this).index(),d=b.data.self,e=a.inArray(c,d.state.sortList);b.preventDefault(),d.settings.sortStartCB&&"function"==typeof d.settings.sortStartCB&&d.settings.sortStartCB.call(d),b.shiftKey?0>e?(d.state.sortList.push(c),d.state.colSettings[c].sortDir="asc"):"asc"==d.state.colSettings[c].sortDir?d.state.colSettings[c].sortDir="desc":d.state.colSettings[c].sortDir="asc":(d.state.sortList=[c],0>e?d.state.colSettings[c].sortDir="asc":"asc"==d.state.colSettings[c].sortDir?d.state.colSettings[c].sortDir="desc":d.state.colSettings[c].sortDir="asc"),d.doSorting(),d.settings.sortEndCB&&"function"==typeof d.settings.sortEndCB&&d.settings.sortEndCB.call(d)},handleIppChange:function(a){var b=a.data.self;b.state.itemsPerPage=parseInt(this.value),b.state.pagingStart=0,b.createTableBody()},handlePageChange:function(b){var c=parseInt(a(this).text())-1,d=b.data.self,e=Math.ceil(d.state.tblData.length/d.state.itemsPerPage);0>c||c>=e||(d.state.pagingStart=c*d.state.itemsPerPage,d.createTableBody())},sanityCheck:function(){return!(this.state.tblData.length>0&&this.state.colSettings.length!=this.state.tblData[0].data.length)},showError:function(a){console.log("Slimtable: "+a)},getState:function(a){var b,c=a.data("slimTableObj");return c&&c.state?(b=c.state,{colNumber:b.colNumber,itemsPerPage:b.itemsPerPage,pagingStart:b.pagingStart,colSettings:b.colSettings,sortList:b.sortList}):{}}};a.fn.slimtable=function(c){return"undefined"!=typeof c&&"getState"===c?b.getState(a(this[0])):this.each(function(){var d=Object.create(b);d.init(a(this),c)})}}(jQuery);